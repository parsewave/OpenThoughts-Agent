# syntax=docker/dockerfile:1
FROM nvidia/cuda:12.8.0-cudnn-runtime-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    curl \
    ca-certificates \
    build-essential \
    python3 \
    python3-pip \
    python3-venv \
    docker.io \
    && rm -rf /var/lib/apt/lists/*

# Note: We install docker.io for CLI only (not running daemon).
# This enables Harbor's Docker backend via host socket passthrough.

RUN pip3 install --upgrade pip uv && \
    uv venv --python 3.12 /opt/openthoughts/.venv

ENV VIRTUAL_ENV=/opt/openthoughts/.venv
ENV PATH="$VIRTUAL_ENV/bin:$PATH"

WORKDIR /opt/openthoughts
COPY pyproject.toml ./
COPY README.md ./
COPY eval ./eval
COPY hpc ./hpc
COPY scripts ./scripts
COPY data ./data
COPY database ./database
COPY sft ./sft
COPY rl ./rl
COPY assets ./assets
COPY build_support.py ./
COPY setup.py ./
COPY CLAUDE.md ./
COPY CONTRIBUTING.md ./
COPY LICENSE.txt ./
COPY docker ./docker

ENV UV_HTTP_TIMEOUT=300
ENV UV_RETRIES=5
RUN . /opt/openthoughts/.venv/bin/activate && uv pip install -e ".[datagen,cloud,harbor-all]"
RUN echo "ulimit -n 65535" >> /etc/profile.d/openthoughts-ulimit.sh

CMD ["bash"]
